<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Uncertainty estimates with layer_dense_variational • tfprobability</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Uncertainty estimates with layer_dense_variational">
<meta property="og:description" content="tfprobability">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tfprobability</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.12.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/dynamic_linear_models.html">Dynamic linear models</a>
    </li>
    <li>
      <a href="../articles/hamiltonian_monte_carlo.html">Multi-level modeling with Hamiltonian Monte Carlo</a>
    </li>
    <li>
      <a href="../articles/layer_dense_variational.html">Uncertainty estimates with layer_dense_variational</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rstudio/tfprobability/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="layer_dense_variational_files/header-attrs-2.5/header-attrs.js"></script><link href="layer_dense_variational_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="layer_dense_variational_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Uncertainty estimates with layer_dense_variational</h1>
                        <h4 class="author">Sigrid Keydana</h4>
            
            <h4 class="date">2021-05-20</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/rstudio/tfprobability/blob/master/vignettes/layer_dense_variational.Rmd"><code>vignettes/layer_dense_variational.Rmd</code></a></small>
      <div class="hidden name"><code>layer_dense_variational.Rmd</code></div>

    </div>

    
    
<p>With <code>tfprobability</code>, we can compute uncertainty estimates for <code>keras</code> layers. This vignette shows how to do this for dense layers.</p>
<p>Our example will have two types of uncertainty estimated:</p>
<ul>
<li>that due to variation in the data (irreducible; a.k.a. <em>aleatoric</em>)</li>
<li>that due to the fact that we don’t know the true model (theoretically, minimizable in the limit of infinite data, a.k.a. <em>epistemic</em>)</li>
</ul>
<p>To achieve the former, we have our model learn the spread in the data; to achieve the latter, we use a <em>variational</em> layer that learns a posterior over the weights. Internally, this layer works by minimizing the <em>evidence lower bound</em> (ELBO), thus striving to find an approximative posterior that does two things:</p>
<ol style="list-style-type: decimal">
<li>fit the actual data well (put differently: achieve high <em>log likelihood</em>), and</li>
<li>stay close to a <em>prior</em> (as measured by <a href="https://en.wikipedia.org/wiki/Kullback%E2%80%93Leibler_divergence">KL divergence</a>).</li>
</ol>
<p>As users, we get to specify the form of the posterior as well as that of the prior. But first let’s generate some data.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span>
<span class="co"># assume it's version 1.14, with eager not yet being the default</span>
<span class="va">tf</span><span class="op">$</span><span class="va">compat</span><span class="op">$</span><span class="va">v1</span><span class="op">$</span><span class="fu">enable_v2_behavior</span><span class="op">(</span><span class="op">)</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tfprobability">tfprobability</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>

<span class="co"># generate the data</span>
<span class="va">x_min</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">40</span>
<span class="va">x_max</span> <span class="op">&lt;-</span> <span class="fl">60</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">150</span>
<span class="va">w0</span> <span class="op">&lt;-</span> <span class="fl">0.125</span>
<span class="va">b0</span> <span class="op">&lt;-</span> <span class="fl">5</span>

<span class="va">normalize</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">x_min</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">x_max</span> <span class="op">-</span> <span class="va">x_min</span><span class="op">)</span>

<span class="co"># training data; predictor </span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x_min</span> <span class="op">+</span> <span class="op">(</span><span class="va">x_max</span> <span class="op">-</span> <span class="va">x_min</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># training data; target</span>
<span class="va">eps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">3</span> <span class="op">*</span> <span class="op">(</span><span class="fl">0.25</span> <span class="op">+</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/normalize.html">normalize</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">w0</span> <span class="op">*</span> <span class="va">x</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="va">b0</span><span class="op">)</span> <span class="op">+</span> <span class="va">eps</span>

<span class="co"># test data (predictor)</span>
<span class="va">x_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">x_min</span>, <span class="va">x_max</span>, length.out <span class="op">=</span> <span class="va">n</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="images/uncertainty_data.png" alt="Simulated data" width="500"><p class="caption">
Simulated data
</p>
</div>
<p>Here is a simple, <em>trainable</em> prior (in <em>empirical Bayesian</em> spirit: A normal distribution where the network may learn the mean (but not the scale). Alternatively, we could disallow learning from the data by setting <code>trainable</code> to <code>FALSE</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">prior_trainable</span> <span class="op">&lt;-</span>
  <span class="kw">function</span><span class="op">(</span><span class="va">kernel_size</span>,
           <span class="va">bias_size</span> <span class="op">=</span> <span class="fl">0</span>,
           <span class="va">dtype</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">n</span> <span class="op">&lt;-</span> <span class="va">kernel_size</span> <span class="op">+</span> <span class="va">bias_size</span>
    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="../reference/layer_variable.html">layer_variable</a></span><span class="op">(</span><span class="va">n</span>, dtype <span class="op">=</span> <span class="va">dtype</span>, trainable <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="../reference/layer_distribution_lambda.html">layer_distribution_lambda</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">{</span>
        <span class="fu"><a href="../reference/tfd_independent.html">tfd_independent</a></span><span class="op">(</span><span class="fu"><a href="../reference/tfd_normal.html">tfd_normal</a></span><span class="op">(</span>loc <span class="op">=</span> <span class="va">t</span>, scale <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,
                        reinterpreted_batch_ndims <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
      <span class="op">}</span><span class="op">)</span>
  <span class="op">}</span></code></pre></div>
<p>The posterior then is a normal, too:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">posterior_mean_field</span> <span class="op">&lt;-</span>
  <span class="kw">function</span><span class="op">(</span><span class="va">kernel_size</span>,
           <span class="va">bias_size</span> <span class="op">=</span> <span class="fl">0</span>,
           <span class="va">dtype</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">n</span> <span class="op">&lt;-</span> <span class="va">kernel_size</span> <span class="op">+</span> <span class="va">bias_size</span>
    <span class="va">c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">expm1</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
      <span class="fu"><a href="../reference/layer_variable.html">layer_variable</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">n</span>, dtype <span class="op">=</span> <span class="va">dtype</span><span class="op">)</span>,
      <span class="fu"><a href="../reference/layer_distribution_lambda.html">layer_distribution_lambda</a></span><span class="op">(</span>
        make_distribution_fn <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">{</span>
          <span class="fu"><a href="../reference/tfd_independent.html">tfd_independent</a></span><span class="op">(</span><span class="fu"><a href="../reference/tfd_normal.html">tfd_normal</a></span><span class="op">(</span>
            loc <span class="op">=</span> <span class="va">t</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">]</span>,
            scale <span class="op">=</span> <span class="fl">1e-5</span> <span class="op">+</span> <span class="va">tf</span><span class="op">$</span><span class="va">nn</span><span class="op">$</span><span class="fu">softplus</span><span class="op">(</span><span class="va">c</span> <span class="op">+</span> <span class="va">t</span><span class="op">[</span><span class="op">(</span><span class="va">n</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">n</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
            <span class="op">)</span>, reinterpreted_batch_ndims <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
        <span class="op">}</span>
      <span class="op">)</span>
    <span class="op">)</span><span class="op">)</span>
  <span class="op">}</span></code></pre></div>
<p>Now for the main model. The variational-dense layer is defined to have two units, one for the distribution of means and distribution of scales each. <code>layer_distribution_lambda</code> then takes their respective outputs as the mean and scale of the posterior distribution.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/layer_dense_variational.html">layer_dense_variational</a></span><span class="op">(</span>
    units <span class="op">=</span> <span class="fl">2</span>,
    make_posterior_fn <span class="op">=</span> <span class="va">posterior_mean_field</span>,
    make_prior_fn <span class="op">=</span> <span class="va">prior_trainable</span>,
    <span class="co"># scale by the size of the dataset</span>
    kl_weight <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">n</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/layer_distribution_lambda.html">layer_distribution_lambda</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
    <span class="fu"><a href="../reference/tfd_normal.html">tfd_normal</a></span><span class="op">(</span>loc <span class="op">=</span> <span class="va">x</span><span class="op">[</span>, <span class="fl">1</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>,
               scale <span class="op">=</span> <span class="fl">1e-3</span> <span class="op">+</span> <span class="va">tf</span><span class="op">$</span><span class="va">math</span><span class="op">$</span><span class="fu">softplus</span><span class="op">(</span><span class="fl">0.01</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span>, <span class="fl">2</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span>
               <span class="op">)</span>
    <span class="op">)</span></code></pre></div>
<p>The model is then simply trained to minimize the negative log likelihood, and fitted like a normal <code>keras</code> network.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">negloglik</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span>, <span class="va">model</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="va">model</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/tfd_log_prob.html">tfd_log_prob</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>
<span class="va">model</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>optimizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adam.html">optimizer_adam</a></span><span class="op">(</span>lr <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span>, loss <span class="op">=</span> <span class="va">negloglik</span><span class="op">)</span>
<span class="va">model</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, epochs <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></code></pre></div>
<p>Because of the uncertainty in the weights, this model does not predict one line, but an ensemble of lines. Each of these lines has its own opinion about the spread in the data. Here is a way we could display this – each colored line is the mean of a distribution, surrounded by a confidence band indicating +/- two standard deviations.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># each time we ask the model to predict, we get a different line</span>
<span class="va">yhats</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">model</span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="va">x_test</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">means</span> <span class="op">&lt;-</span>
  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">yhats</span>, <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/compose.html">compose</a></span><span class="op">(</span><span class="va">as.matrix</span>, <span class="va">tfd_mean</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">abind</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/abind/man/abind.html">abind</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">sds</span> <span class="op">&lt;-</span>
  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">yhats</span>, <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/compose.html">compose</a></span><span class="op">(</span><span class="va">as.matrix</span>, <span class="va">tfd_stddev</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">abind</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/abind/man/abind.html">abind</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">means_gathered</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">x_test</span>, <span class="va">means</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span><span class="op">(</span>key <span class="op">=</span> <span class="va">run</span>, value <span class="op">=</span> <span class="va">mean_val</span>,<span class="op">-</span><span class="va">X1</span><span class="op">)</span>
<span class="va">sds_gathered</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">x_test</span>, <span class="va">sds</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span><span class="op">(</span>key <span class="op">=</span> <span class="va">run</span>, value <span class="op">=</span> <span class="va">sd_val</span>,<span class="op">-</span><span class="va">X1</span><span class="op">)</span>

<span class="va">lines</span> <span class="op">&lt;-</span>
  <span class="va">means_gathered</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">sds_gathered</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"X1"</span>, <span class="st">"run"</span><span class="op">)</span><span class="op">)</span>
<span class="va">mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">means</span>, <span class="fl">1</span>, <span class="va">mean</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_test</span>, y <span class="op">=</span> <span class="va">mean</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"violet"</span>, size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>
    data <span class="op">=</span> <span class="va">lines</span>,
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X1</span>, y <span class="op">=</span> <span class="va">mean_val</span>, color <span class="op">=</span> <span class="va">run</span><span class="op">)</span>,
    alpha <span class="op">=</span> <span class="fl">0.6</span>,
    size <span class="op">=</span> <span class="fl">0.5</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span>
    data <span class="op">=</span> <span class="va">lines</span>,
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>
      x <span class="op">=</span> <span class="va">X1</span>,
      ymin <span class="op">=</span> <span class="va">mean_val</span> <span class="op">-</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">sd_val</span>,
      ymax <span class="op">=</span> <span class="va">mean_val</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">sd_val</span>,
      group <span class="op">=</span> <span class="va">run</span>
    <span class="op">)</span>,
    alpha <span class="op">=</span> <span class="fl">0.05</span>,
    fill <span class="op">=</span> <span class="st">"grey"</span>,
    inherit.aes <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span></code></pre></div>
<div class="figure">
<img src="images/uncertainty.png" alt="Displaying both epistemic and aleatoric uncertainty on the simulated dataset." width="500"><p class="caption">
Displaying both epistemic and aleatoric uncertainty on the simulated dataset.
</p>
</div>
<p>Summing up, using <code>layer_dense_variational</code> we are able to construct a posterior predictive distribution from an ensemble of models, where each single model by itself learns the spread in the data. For some more background narrative on this topic, see <a href="https://blogs.rstudio.com/ai/posts/2019-06-05-uncertainty-estimates-tfprobability/">Adding uncertainty estimates to Keras models with tfprobability</a>.</p>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Sigrid Keydana.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
