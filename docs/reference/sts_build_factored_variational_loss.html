<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Build a loss function for variational inference in STS models. — sts_build_factored_variational_loss • tfprobability</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />


<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Build a loss function for variational inference in STS models. — sts_build_factored_variational_loss" />
<meta property="og:description" content="Variational inference searches for the distribution within some family of
approximate posteriors that minimizes a divergence between the approximate
posterior q(z) and true posterior p(z|observed_time_series). By converting
inference to optimization, it's generally much faster than sampling-based
inference algorithms such as HMC. The tradeoff is that the approximating
family rarely contains the true posterior, so it may miss important aspects of
posterior structure (in particular, dependence between variables) and should
not be blindly trusted. Results may vary; it's generally wise to compare to
HMC to evaluate whether inference quality is sufficient for your task at hand." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tfprobability</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.11.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/dynamic_linear_models.html">Dynamic linear models</a>
    </li>
    <li>
      <a href="../articles/hamiltonian_monte_carlo.html">Multi-level modeling with Hamiltonian Monte Carlo</a>
    </li>
    <li>
      <a href="../articles/layer_dense_variational.html">Uncertainty estimates with layer_dense_variational</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/rstudio/tfprobability/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Build a loss function for variational inference in STS models.</h1>
    <small class="dont-index">Source: <a href='https://github.com/rstudio/tfprobability/blob/master/R/sts-functions.R'><code>R/sts-functions.R</code></a></small>
    <div class="hidden name"><code>sts_build_factored_variational_loss.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Variational inference searches for the distribution within some family of
approximate posteriors that minimizes a divergence between the approximate
posterior <code><a href='https://rdrr.io/r/base/quit.html'>q(z)</a></code> and true posterior <code>p(z|observed_time_series)</code>. By converting
inference to optimization, it's generally much faster than sampling-based
inference algorithms such as HMC. The tradeoff is that the approximating
family rarely contains the true posterior, so it may miss important aspects of
posterior structure (in particular, dependence between variables) and should
not be blindly trusted. Results may vary; it's generally wise to compare to
HMC to evaluate whether inference quality is sufficient for your task at hand.</p>
    </div>

    <pre class="usage"><span class='fu'>sts_build_factored_variational_loss</span><span class='op'>(</span>
  <span class='va'>observed_time_series</span>,
  <span class='va'>model</span>,
  init_batch_shape <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='op'>)</span>,
  seed <span class='op'>=</span> <span class='cn'>NULL</span>,
  name <span class='op'>=</span> <span class='cn'>NULL</span>
<span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>observed_time_series</th>
      <td><p><code>float</code> <code>tensor</code> of shape
<code>concat([sample_shape, model.batch_shape, [num_timesteps, 1]])</code> where
<code>sample_shape</code> corresponds to i.i.d. observations, and the trailing <code>[1]</code>
dimension may (optionally) be omitted if <code>num_timesteps &gt; 1</code>. May
optionally be an instance of <code>sts_masked_time_series</code>, which includes
a mask <code>tensor</code> to specify timesteps with missing observations.</p></td>
    </tr>
    <tr>
      <th>model</th>
      <td><p>An instance of <code>StructuralTimeSeries</code> representing a
time-series model. This represents a joint distribution over
time-series and their parameters with batch shape <code>[b1, ..., bN]</code>.</p></td>
    </tr>
    <tr>
      <th>init_batch_shape</th>
      <td><p>Batch shape (<code>list</code>) of initial
states to optimize in parallel. Default value: <code><a href='https://rdrr.io/r/base/list.html'>list()</a></code>. (i.e., just run a single optimization).</p></td>
    </tr>
    <tr>
      <th>seed</th>
      <td><p>integer to seed the random number generator.</p></td>
    </tr>
    <tr>
      <th>name</th>
      <td><p>name prefixed to ops created by this function. Default value: <code>NULL</code>
(i.e., 'build_factored_variational_loss').</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>list of:</p><ul>
<li><p>variational_loss: <code>float</code> <code>Tensor</code> of shape
<code>tf$concat([init_batch_shape, model$batch_shape])</code>, encoding a stochastic
estimate of an upper bound on the negative model evidence <code>-log p(y)</code>.
Minimizing this loss performs variational inference; the gap between the
variational bound and the true (generally unknown) model evidence
corresponds to the divergence <code>KL[q||p]</code> between the approximate and true
posterior.</p></li>
<li><p>variational_distributions: a named list giving
the approximate posterior for each model parameter. The keys are
<code>character</code> parameter names in order, corresponding to
<code>[param.name for param in model.parameters]</code>. The values are
<code>tfd$Distribution</code> instances with batch shape
<code>tf$concat([init_batch_shape, model$batch_shape])</code>; these will typically be
of the form <code>tfd$TransformedDistribution(tfd.Normal(...), bijector=param.bijector)</code>.</p></li>
</ul>

    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>This method constructs a loss function for variational inference using the
Kullback-Liebler divergence <code>KL[q(z) || p(z|observed_time_series)]</code>, with an
approximating family given by independent Normal distributions transformed to
the appropriate parameter space for each parameter. Minimizing this loss (the
negative ELBO) maximizes a lower bound on the log model evidence
<code>-log p(observed_time_series)</code>. This is equivalent to the 'mean-field' method
implemented in Kucukelbir et al. (2017) and is a standard approach.
The resulting posterior approximations are unimodal; they will tend to underestimate posterior
uncertainty when the true posterior contains multiple modes
(the <code>KL[q||p]</code> divergence encourages choosing a single mode) or dependence between variables.</p>
    <h2 class="hasAnchor" id="references"><a class="anchor" href="#references"></a>References</h2>

    

<ul>
<li><p><a href='https://arxiv.org/abs/1603.00788'>Alp Kucukelbir, Dustin Tran, Rajesh Ranganath, Andrew Gelman, and David M. Blei. Automatic Differentiation Variational Inference. In <em>Journal of Machine Learning Research</em>, 2017.</a></p></li>
</ul>

    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'><p>Other sts-functions: 
<code><a href='sts_build_factored_surrogate_posterior.html'>sts_build_factored_surrogate_posterior</a>()</code>,
<code><a href='sts_decompose_by_component.html'>sts_decompose_by_component</a>()</code>,
<code><a href='sts_decompose_forecast_by_component.html'>sts_decompose_forecast_by_component</a>()</code>,
<code><a href='sts_fit_with_hmc.html'>sts_fit_with_hmc</a>()</code>,
<code><a href='sts_forecast.html'>sts_forecast</a>()</code>,
<code><a href='sts_one_step_predictive.html'>sts_one_step_predictive</a>()</code>,
<code><a href='sts_sample_uniform_initial_state.html'>sts_sample_uniform_initial_state</a>()</code></p></div>

  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Sigrid Keydana.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


